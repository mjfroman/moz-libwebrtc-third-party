From 497bfde1cf89ca66777dcb3314c4eef331d3e7ab Mon Sep 17 00:00:00 2001
From: Andrew Grieve <agrieve@chromium.org>
Date: Wed, 1 Apr 2020 10:03:06 -0400
Subject: [PATCH 2/5] Adds --feature-jar to R8 command

Chrome needs this to expose feature splits via command-line
---
 src/main/java/com/android/tools/r8/R8Command.java     | 11 +++++++++++
 .../java/com/android/tools/r8/R8CommandParser.java    |  6 ++++++
 2 files changed, 17 insertions(+)

diff --git a/src/main/java/com/android/tools/r8/R8Command.java b/src/main/java/com/android/tools/r8/R8Command.java
index 4051f9cef..6d034d5b8 100644
--- a/src/main/java/com/android/tools/r8/R8Command.java
+++ b/src/main/java/com/android/tools/r8/R8Command.java
@@ -42,6 +42,8 @@ import java.util.function.BiPredicate;
 import java.util.function.Consumer;
 import java.util.function.Function;
 
+import com.android.tools.r8.DexIndexedConsumer.DirectoryConsumer;
+
 /**
  * Immutable command structure for an invocation of the {@link R8} compiler.
  *
@@ -234,6 +236,15 @@ public final class R8Command extends BaseCompilerCommand {
       return self();
     }
 
+    public Builder addFeatureJar(Path inputJarPath, Path outputPath) {
+      addFeatureSplit(splitBuilder ->
+          splitBuilder
+            .addProgramResourceProvider(ArchiveProgramResourceProvider.fromArchive(inputJarPath))
+            .setProgramConsumer(new DirectoryConsumer(outputPath))
+            .build());
+      return self();
+    }
+
     /**
      * Set a consumer for receiving the proguard-map content.
      *
diff --git a/src/main/java/com/android/tools/r8/R8CommandParser.java b/src/main/java/com/android/tools/r8/R8CommandParser.java
index 22ebb5e42..b53e4c59e 100644
--- a/src/main/java/com/android/tools/r8/R8CommandParser.java
+++ b/src/main/java/com/android/tools/r8/R8CommandParser.java
@@ -24,6 +24,7 @@ public class R8CommandParser extends BaseCompilerCommandParser<R8Command, R8Comm
           "--min-api",
           "--main-dex-rules",
           "--main-dex-list",
+          "--feature-jar",
           "--main-dex-list-output",
           "--pg-conf",
           "--pg-map-output",
@@ -205,6 +206,11 @@ public class R8CommandParser extends BaseCompilerCommandParser<R8Command, R8Comm
         builder.setDisableDesugaring(true);
       } else if (arg.equals("--main-dex-rules")) {
         builder.addMainDexRulesFiles(Paths.get(nextArg));
+      } else if (arg.equals("--feature-jar")) {
+        String[] argParts = nextArg.split(":");
+        String featureJarInputPath = argParts[0];
+        String featureJarOutputPath = argParts[1];
+        builder.addFeatureJar(Paths.get(featureJarInputPath), Paths.get(featureJarOutputPath));
       } else if (arg.equals("--main-dex-list")) {
         builder.addMainDexListFiles(Paths.get(nextArg));
       } else if (arg.equals("--main-dex-list-output")) {
-- 
2.26.0.rc2.310.g2932bb562d-goog

