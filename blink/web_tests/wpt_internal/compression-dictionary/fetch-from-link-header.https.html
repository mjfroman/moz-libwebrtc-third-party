<!DOCTYPE html>
<html>
<head>
  <title>Load compression dictionary from link header</title>
  <script src="/resources/testharness.js"></script>
  <script src="/resources/testharnessreport.js"></script>
  <script src="/common/get-host-info.sub.js"></script>
  <script src="/common/utils.js"></script>
  <script src="resources/dict_fetch_test.js"></script>
  <script src="resources/compression-dictionary-origin-trial.js"></script>
</head>
<body>
  <script>
    enableCompressionDictionaryOriginTrial()

    function add_iframe_with_dictionary_link_header(token, remote_origin) {
      const iframe_node = document.createElement('iframe');
      iframe_url = 'resources/dictionary-link-header.py?token=' + token;
      if (remote_origin) {
        cross_origin_path = remote_origin + '/wpt_internal/compression-dictionary/resources/';
        iframe_url += '&cross-origin-path=' + cross_origin_path;
      }
      iframe_node.src = iframe_url;
      document.body.appendChild(iframe_node);
    }

    promise_test(async test => {
      const dict_token = token();
      add_iframe_with_dictionary_link_header(dict_token, null);

      // The dictionary will be loaded when the browser is idle.
      await new Promise(resolve => window.requestIdleCallback(resolve));

      const response = await fetch('resources/dict.py?token=' + dict_token + '&previous_header=1');
      const dict_fetch_response = await response.json();
      checkSameOriginDictionaryFetchHeaders(dict_fetch_response);
    }, 'Dictionary correctly fetched from link headers');

    promise_test(async test => {
      const dict_token = token();
      add_iframe_with_dictionary_link_header(dict_token, get_host_info().HTTPS_NOTSAMESITE_ORIGIN);

      // The dictionary will be loaded when the browser is idle.
      await new Promise(resolve => window.requestIdleCallback(resolve));

      const response = await fetch('resources/dict.py?token=' + dict_token + '&previous_header=1');
      const dict_fetch_response = await response.json();
      checkNotSameSiteDictionaryFetchHeaders(dict_fetch_response);
    }, 'Not-same-site origin dictionary correctly fetched from link headers');

    promise_test(async test => {
      const dict_token = token();
      add_iframe_with_dictionary_link_header(dict_token, get_host_info().HTTPS_REMOTE_ORIGIN);

      // The dictionary will be loaded when the browser is idle.
      await new Promise(resolve => window.requestIdleCallback(resolve));

      const response = await fetch('resources/dict.py?token=' + dict_token + '&previous_header=1');
      const dict_fetch_response = await response.json();
      checkRemoteOriginDictionaryFetchHeaders(dict_fetch_response);
    }, 'Remote origin dictionary correctly fetched from link headers');
  </script>
</body>
</html>
