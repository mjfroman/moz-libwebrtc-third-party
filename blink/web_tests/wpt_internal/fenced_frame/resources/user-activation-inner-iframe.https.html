<!DOCTYPE html>
<script src="/resources/testharness.js"></script>
<script src="/resources/testdriver.js"></script>
<script src="/resources/testdriver-actions.js"></script>
<script src="/resources/testdriver-vendor.js"></script>
<script src="utils.js"></script>
<title>iframe content to test user activations.</title>

<body>
  <script>
    async function init() {
      const url_parameters = new URL(location.href).searchParams;
      const ack_key = url_parameters.get('uuid');

      const user_activation_key = stringToStashKey("user_activation");

      // Wait to start the test until the embedder tells us it's time.
      await nextValueFromServer(ack_key);

      // Check that the iframe hasn't been activated yet.
      assert_false(navigator.userActivation.hasBeenActive,
                   "The iframe has not been activated yet.");
      assert_false(navigator.userActivation.isActive,
                   "The iframe is not currently active.");

      // Tell the embedder that we're done, and wait.
      writeValueToServer(user_activation_key, "pass");
      await nextValueFromServer(ack_key);


      // Check that the iframe has already activated.
      assert_true(navigator.userActivation.hasBeenActive,
                   "The iframe has already been activated.");
      assert_true(navigator.userActivation.isActive,
                   "The iframe is currently active.");

      // Tell the embedder that we're done, and wait.
      writeValueToServer(user_activation_key, "pass");
      await nextValueFromServer(ack_key);


      // Check that the iframe has been activated again.
      assert_true(navigator.userActivation.isActive,
                  "The iframe is currently active again.");

      // Tell the embedder that we're done.
      writeValueToServer(user_activation_key, "pass");
    }

    init();
  </script>
</body>
