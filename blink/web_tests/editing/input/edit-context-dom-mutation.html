<head>
  <title>This tests the new EditContext APIs regarding DOM mutation</title>
  <script src="../../resources/testharness.js"></script>
  <script src="../../resources/testharnessreport.js"></script>
</head>
<body>
<script>
  let onMacPlatform = navigator.userAgent.search(/\bMac OS X\b/) != -1;
  if (onMacPlatform) {
    formatCommands = [{'modifier': 'metaKey', 'key': 'b', 'command': 'formatBold'},
                      {'modifier': 'metaKey', 'key': 'i', 'command': 'formatItalic'},
                      {'modifier': 'ctrlKey', 'key': 'u', 'command': 'formatUnderline'}];
  } else {
    formatCommands = [{'modifier': 'ctrlKey', 'key': 'b', 'command': 'formatBold'},
                      {'modifier': 'ctrlKey', 'key': 'i', 'command': 'formatItalic'},
                      {'modifier': 'ctrlKey', 'key': 'u', 'command': 'formatUnderline'}];
  }

  formatCommands.forEach( testcase => {
    test(function () {
      let editContext = new EditContext();
      assert_not_equals(editContext, null);
      let div = document.createElement("div");
      document.body.appendChild(div);

      div.innerHTML = "abc";
      div.editContext = editContext;
      div.focus();

      let got_before_input_event = false;
      div.addEventListener("beforeinput", (e) => {
        if (e.inputType === testcase['command']) {
          got_before_input_event = true;
        }
      });

      window.getSelection().selectAllChildren(div);
      eventSender.keyDown(testcase['key'], [testcase['modifier']]);
      assert_equals(div.childNodes[0].nodeType, Node.TEXT_NODE, "DOM shouldn't be modified, i.e. no extra <b>, <i> or <u>");
      assert_equals(got_before_input_event, true, "The beforeinput event should be fired.");

      document.body.removeChild(div);
    }, "EditContext should disable DOM mutation from " + testcase['modifier'] + " + " + testcase['key']);
  });

  if (onMacPlatform) {
    formatCommands = [{'modifier': 'shiftKey', 'key': 'Delete', 'command': 'deleteByCut'}];
  } else {
    formatCommands = [{'modifier': 'shiftKey', 'key': 'Delete', 'command': 'deleteByCut'},
                      {'modifier': 'ctrlKey', 'key': 'x', 'command': 'deleteByCut'}];
  }

  formatCommands.forEach( testcase => {
    test(function () {
      let editContext = new EditContext();
      assert_not_equals(editContext, null);
      let div = document.createElement("div");
      document.body.appendChild(div);
      let myText = "abc";
      div.innerHTML = myText;
      div.editContext = editContext;
      div.focus();

      let got_before_input_event = false;
      div.addEventListener("beforeinput", (e) => {
        if (e.inputType === testcase['command']) {
          got_before_input_event = true;
        }
      });
      window.getSelection().selectAllChildren(div);
      eventSender.keyDown(testcase['key'], [testcase['modifier']]);
      assert_equals(div.innerText, myText, "DOM shouldn't be modified");
      assert_equals(got_before_input_event, true, "The beforeinput event should be fired.");

      document.body.removeChild(div);
    }, "EditContext should disable DOM mutation from " + testcase['modifier'] + " + " + testcase['key']);
  });

  if (onMacPlatform) {
    formatCommands = [{'modifier': 'shiftKey', 'key': 'Insert', 'command': 'insertFromPaste'}];
  } else {
    formatCommands = [{'modifier': 'shiftKey', 'key': 'Insert', 'command': 'insertFromPaste'},
                      {'modifier': 'ctrlKey', 'key': 'v', 'command': 'insertFromPaste'}];
  }

  formatCommands.forEach( testcase => {
    test(function () {
      let editContext = new EditContext();
      assert_not_equals(editContext, null);
      let div = document.createElement("div");
      document.body.appendChild(div);
      let myText = "abc";
      div.innerHTML = myText;
      div.editContext = editContext;
      div.focus();

      let got_before_input_event = false;
      div.addEventListener("beforeinput", (e) => {
        if (e.inputType === testcase['command']) {
          got_before_input_event = true;
          assert_equals(e.dataTransfer.getData("text"), myText, "The beforeinput event should contain clipboard data");
        }
      });
      window.getSelection().selectAllChildren(div);
      // copy 'abc'.
      eventSender.keyDown('c', ['ctrlKey']);
      window.getSelection().collapse(div);
      // paste 'abc' at the begining.
      eventSender.keyDown(testcase['key'], [testcase['modifier']]);
      assert_equals(div.innerText, myText, "DOM shouldn't be modified");
      assert_equals(got_before_input_event, true, "The beforeinput event should be fired.");

      document.body.removeChild(div);
    }, "EditContext should disable DOM mutation from " + testcase['modifier'] + " + " + testcase['key']);
  });

  test(() => {
    let editContext = new EditContext();
    let div = document.createElement("div");
    document.body.appendChild(div);
    let myText = "appla";
    div.innerHTML = myText;
    div.editContext = editContext;
    div.focus();

    // The beforeinput event should be fired as usual.
    div.addEventListener('beforeinput', (event) => {
      assert_equals(event.inputType, 'insertReplacementText');
      assert_equals(event.dataTransfer.getData('text/plain'), 'apple');
      assert_equals(event.getTargetRanges().length, 1);
    });

    let selection = window.getSelection();
    selection.collapse(div, 0);
    selection.extend(div, 1);
    internals.setMarker(document, selection.getRangeAt(0), 'Spelling');
    internals.replaceMisspelled(document, 'apple');
    assert_equals(div.innerText, myText, "DOM shouldn't be modified");
  }, "EditContext should disable DOM mutation from spellcheck");
</script>
</body>
