<!DOCTYPE html>
<title>Credential Manager: End-to-end tests for create(), exercising creation of resident keys on virtual authenticators.</title>
<script src="../resources/testharness.js"></script>
<script src="../resources/testharnessreport.js"></script>
<body>
<script type="module">
import {authenticatorSetup, deepCopy, MAKE_CREDENTIAL_OPTIONS} from './resources/test-inputs.js';
import {TestAuthenticatorManager} from './resources/virtual-navigator-credentials.js';
import {ClientToAuthenticatorProtocol, Ctap2Version} from '/gen/third_party/blink/public/mojom/webauthn/virtual_authenticator.mojom.m.js';

if (document.location.host != "subdomain.example.test:8443") {
  document.location = "https://subdomain.example.test:8443/credentialmanager/credentialscontainer-create-with-resident-keys.html";
  promise_test(_ => new Promise(_ => {}), "Stall tests on the wrong host.");
}

const credPropsTests = [
  {
    name: "U2F",
    authenticatorArgs: {
      protocol: ClientToAuthenticatorProtocol.U2F,
    },
    expected: {
      discouraged: {
        success: true,
        hasRk: true,
        rk: false,
      },
      preferred: {
        success: true,
        hasRk: true,
        rk: false,
      },
      required: {
        success: false,
      },
    },
  },
  {
    name: "CTAP 2.0 without resident key support",
    authenticatorArgs: {
      protocol: ClientToAuthenticatorProtocol.CTAP2,
      ctap2Version: Ctap2Version.CTAP2_0,
      hasResidentKey: false,
    },
    expected: {
      discouraged: {
        success: true,
        hasRk: true,
        rk: false,
      },
      preferred: {
        success: true,
        hasRk: true,
        rk: false,
      },
      required: {
        success: false,
      },
    },
  },
  {
    name: "CTAP 2.0 with resident key support",
    authenticatorArgs: {
      protocol: ClientToAuthenticatorProtocol.CTAP2,
      ctap2Version: Ctap2Version.CTAP2_0,
      hasResidentKey: true,
    },
    expected: {
      discouraged: {
        success: true,
        // CTAP2.0 authenticators may treat all credentials as discoverable, thus Chrome omits 'rk' in this case.
        hasRk: false,
      },
      preferred: {
        success: true,
        hasRk: true,
        rk: true,
      },
      required: {
        success: true,
        hasRk: true,
        rk: true,
      },
    },
  },
  {
    name: "CTAP 2.1 without resident key support",
    authenticatorArgs: {
      protocol: ClientToAuthenticatorProtocol.CTAP2,
      ctap2Version: Ctap2Version.CTAP2_1,
      hasResidentKey: false,
    },
    expected: {
      discouraged: {
        success: true,
        hasRk: true,
        rk: false,
      },
      preferred: {
        success: true,
        hasRk: true,
        rk: false,
      },
      required: {
        success: false,
      },
    },
  },
  {
    name: "CTAP 2.1 with resident key support",
    authenticatorArgs: {
      protocol: ClientToAuthenticatorProtocol.CTAP2,
      ctap2Version: Ctap2Version.CTAP2_1,
      hasResidentKey: true,
    },
    expected: {
      discouraged: {
        success: true,
        hasRk: true,
        rk: false,
      },
      preferred: {
        success: true,
        hasRk: true,
        rk: true,
      },
      required: {
        success: true,
        hasRk: true,
        rk: true,
      },
    },
  },
];

const manager = new TestAuthenticatorManager;
for (const fixture of credPropsTests) {
  authenticatorSetup(manager, fixture.name, () => {
    for (const rkRequirement of ["discouraged", "preferred", "required"]) {
      promise_test(async t => {
        var customMakeCredOptions = deepCopy(MAKE_CREDENTIAL_OPTIONS);
        customMakeCredOptions.extensions = {credProps: true};

        customMakeCredOptions.authenticatorSelection.residentKey = rkRequirement;
        const promise = navigator.credentials.create({publicKey: customMakeCredOptions});

        assert_true(rkRequirement in fixture.expected);
        const expected = fixture.expected[rkRequirement];
        assert_true('success' in expected);
        if (!expected.success) {
            return promise_rejects_dom(t, "NotAllowedError", promise);
        }

        const cred = await promise;
        assert_true('credProps' in cred.getClientExtensionResults());
        const credProps = cred.getClientExtensionResults().credProps;
        assert_equals('rk' in credProps, expected.hasRk, "hasRk");
        if (expected.hasRk) {
          assert_equals(credProps.rk, expected.rk, "rk");
        }
      }, fixture.name + ": navigator.credentials.create() with credProps extension, rk=" + rkRequirement);
    }
  }, fixture.authenticatorArgs);
}

</script>
